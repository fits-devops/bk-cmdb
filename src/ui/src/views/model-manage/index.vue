<template>
    <div class="group-wrapper">
        <cmdb-main-inject
            :style="{ 'padding-top': showFeatureTips ? '10px' : '' }"
            inject-type="prepend"
            :class="['btn-group', 'clearfix', { sticky: !!scrollTop }]">
            <feature-tips
                :feature-name="'model'"
                :show-tips="showFeatureTips"
                :desc="$t('ModelManagement[\'模型顶部提示\']')"
                :more-href="'https://docs.bk.tencent.com/cmdb/Introduction.html#ModelManagement'"
                @close-tips="showFeatureTips = false">
            </feature-tips>
            <div class="fl">
                <span v-if="isAdminView" style="display: inline-block;"
                    v-cursor="{
                        active: !$isAuthorized($OPERATION.C_MODEL),
                        auth: [$OPERATION.C_MODEL]
                    }">
                    <bk-button type="primary"
                        :disabled="!$isAuthorized($OPERATION.C_MODEL) || modelType === 'disabled'"
                        @click="showModelDialog(false)">
                        {{$t('ModelManagement["新建模型"]')}}
                    </bk-button>
                </span>
                <span v-else style="display: inline-block;"
                    v-cursor="{
                        active: !$isAuthorized($OPERATION.C_MODEL),
                        auth: [$OPERATION.C_MODEL]
                    }">
                    <bk-button type="primary"
                        v-tooltip="$t('ModelManagement[\'新增模型提示\']')"
                        :disabled="!$isAuthorized($OPERATION.C_MODEL) || modelType === 'disabled'"
                        @click="showModelDialog(false)">
                        {{$t('ModelManagement["新建模型"]')}}
                    </bk-button>
                </span>
                <span style="display: inline-block;"
                    v-cursor="{
                        active: !$isAuthorized($OPERATION.C_MODEL_GROUP),
                        auth: [$OPERATION.C_MODEL_GROUP]
                    }">
                    <bk-button type="default"
                        :disabled="!$isAuthorized($OPERATION.C_MODEL_GROUP) || modelType === 'disabled'"
                        @click="showGroupDialog(false)">
                        {{$t('ModelManagement["新建分组"]')}}
                    </bk-button>
                </span>
            </div>
            <div class="model-type-options fr">
                <bk-button class="model-type-button enable"
                    size="mini"
                    :type="modelType === 'enable' ? 'primary' : 'default'"
                    @click="modelType = 'enable'">
                    {{$t('ModelManagement["启用模型"]')}}
                </bk-button>
                <bk-tooltip
                    :content="$t('ModelManagement[\'停用模型提示\']')"
                    placenment="bottom"
                    v-if="!disabledClassifications.length">
                    <bk-button class="model-type-button disabled"
                        v-tooltip="$t('ModelManagement[\'停用模型提示\']')"
                        size="mini"
                        :disabled="!disabledClassifications.length"
                        :type="modelType === 'disabled' ? 'primary' : 'default'"
                        @click="modelType = 'disabled'">
                        {{$t('ModelManagement["停用模型"]')}}
                    </bk-button>
                </bk-tooltip>
                <bk-button class="model-type-button disabled"
                    v-else
                    size="mini"
                    :disabled="!disabledClassifications.length"
                    :type="modelType === 'disabled' ? 'primary' : 'default'"
                    @click="modelType = 'disabled'">
                    {{$t('ModelManagement["停用模型"]')}}
                </bk-button>
            </div>
        </cmdb-main-inject>
        <ul class="group-list">
            <li class="group-item clearfix"
                v-for="(classification, classIndex) in currentClassifications"
                :key="classIndex">
                <div class="group-title">
                    <span>{{classification['classification_name']}}</span>
                    <span class="number">({{classification['bk_objects'].length}})</span>
                    <template v-if="isEditable(classification)">
                        <i class="icon-cc-edit text-primary"
                            :style="{ color: $isAuthorized($OPERATION.U_MODEL_GROUP) ? '' : '#e6e6e6 !important' }"
                            v-cursor="{
                                active: !$isAuthorized($OPERATION.U_MODEL_GROUP),
                                auth: [$OPERATION.U_MODEL_GROUP]
                            }"
                            @click="showGroupDialog(true, classification)">
                        </i>
                        <i class="icon-cc-del text-primary"
                            :style="{ color: $isAuthorized($OPERATION.D_MODEL_GROUP) ? '' : '#e6e6e6 !important' }"
                            v-cursor="{
                                active: !$isAuthorized($OPERATION.D_MODEL_GROUP),
                                auth: [$OPERATION.D_MODEL_GROUP]
                            }"
                            @click="deleteGroup(classification)">
                        </i>
                    </template>
                </div>
                <ul class="model-list clearfix">
                    <li class="model-item"
                        :class="{
                            'ispaused': model['ispaused'],
                            'ispre': isInner(model)
                        }"
                        v-for="(model, modelIndex) in classification['bk_objects']"
                        :key="modelIndex"
                        @click="modelClick(model)">
                        <div class="icon-box">
                            <i class="icon" :class="[model['obj_icon']]"></i>
                        </div>
                        <div class="model-details">
                            <p class="model-name" :title="model['obj_name']">{{model['obj_name']}}</p>
                            <p class="model-id" :title="model['obj_id']">{{model['obj_id']}}</p>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        <bk-dialog
            class="group-dialog dialog"
            :close-icon="false"
            :has-header="false"
            :width="600"
            :padding="0"
            :quick-close="false"
            :is-show.sync="groupDialog.isShow">
            <div slot="content" class="dialog-content">
                <p class="title">{{groupDialog.title}}</p>
                <div class="content">
                    <label>
                        <div class="label-title">
                            {{$t('ModelManagement["唯一标识"]')}}<span class="color-danger">*</span>
                        </div>
                        <div class="cmdb-form-item" :class="{ 'is-error': errors.has('classifyId') }">
                            <input type="text" class="cmdb-form-input"
                                name="classifyId"
                                :placeholder="$t('ModelManagement[\'请输入唯一标识\']')"
                                :disabled="groupDialog.isEdit"
                                v-model.trim="groupDialog.data['classification_id']"
                                v-validate="'required|classifyId'">
                            <p class="form-error">{{errors.first('classifyId')}}</p>
                        </div>
                        <i class="bk-icon icon-info-circle" v-tooltip="$t('ModelManagement[\'下划线，数字，英文小写的组合\']')"></i>
                    </label>
                    <label>
                        <span class="label-title">
                            {{$t('ModelManagement["名称"]')}}
                        </span>
                        <span class="color-danger">*</span>
                        <div class="cmdb-form-item" :class="{ 'is-error': errors.has('classifyName') }">
                            <input type="text"
                                class="cmdb-form-input"
                                name="classifyName"
                                :placeholder="$t('ModelManagement[\'请输入名称\']')"
                                v-model.trim="groupDialog.data['classification_name']"
                                v-validate="'required|classifyName'">
                            <p class="form-error">{{errors.first('classifyName')}}</p>
                        </div>
                    </label>
                </div>
            </div>
            <div slot="footer" class="footer">
                <bk-button type="primary" :loading="$loading(['updateClassification', 'createClassification'])" @click="saveGroup">{{$t("Common['保存']")}}</bk-button>
                <bk-button type="default" @click="hideGroupDialog">{{$t("Common['取消']")}}</bk-button>
            </div>
        </bk-dialog>
        <the-create-model
            :is-show.sync="modelDialog.isShow"
            :title="$t('ModelManagement[\'新建模型\']')"
            @confirm="saveModel">
        </the-create-model>
    </div>
</template>

<script>
    import cmdbMainInject from '@/components/layout/main-inject'
    import theCreateModel from '@/components/model-manage/_create-model'
    import featureTips from '@/components/feature-tips/index'
    // import theModel from './children'
    import { mapGetters, mapMutations, mapActions } from 'vuex'
    import { addMainScrollListener, removeMainScrollListener } from '@/utils/main-scroller'
    export default {
        components: {
            // theModel,
            theCreateModel,
            cmdbMainInject,
            featureTips
        },
        data () {
            return {
                showFeatureTips: false,
                scrollHandler: null,
                scrollTop: 0,
                groupDialog: {
                    isShow: false,
                    isEdit: false,
                    title: this.$t('ModelManagement["新建分组"]'),
                    data: {
                        classification_id: '',
                        classification_name: '',
                        id: ''
                    }
                },
                modelDialog: {
                    isShow: false
                },
                modelType: 'enable'
            }
        },
        computed: {
            ...mapGetters(['supplierAccount', 'userName', 'admin', 'isAdminView', 'isBusinessSelected', 'featureTipsParams']),
            ...mapGetters('objectModelClassify', [
                'classifications'
            ]),
            enableClassifications () {
                const enableClassifications = []
                this.classifications.forEach(classification => {
                    enableClassifications.push({
                        ...classification,
                        'bk_objects': classification['bk_objects'].filter(model => {
                            return !model['ispaused'] && !['process', 'plat'].includes(model['obj_id'])
                        })
                    })
                })
                return enableClassifications
            },
            disabledClassifications () {
                const disabledClassifications = []
                this.classifications.forEach(classification => {
                    const disabledModels = classification['bk_objects'].filter(model => {
                        return model['ispaused'] && !['process', 'plat'].includes(model['obj_id'])
                    })
                    if (disabledModels.length) {
                        disabledClassifications.push({
                            ...classification,
                            'bk_objects': disabledModels
                        })
                    }
                })
                return disabledClassifications
            },
            currentClassifications () {
                return this.modelType === 'enable' ? this.enableClassifications : this.disabledClassifications
            }
        },
        created () {
            this.$store.commit('setHeaderTitle', this.$t('Nav["模型"]'))
            this.scrollHandler = event => {
                this.scrollTop = event.target.scrollTop
            }
            addMainScrollListener(this.scrollHandler)
            this.searchClassificationsObjects({
                params: this.$injectMetadata()
            })
            this.showFeatureTips = this.featureTipsParams['model']
        },
        beforeDestroy () {
            removeMainScrollListener(this.scrollHandler)
        },
        methods: {
            ...mapMutations('objectModelClassify', [
                'updateClassify',
                'deleteClassify'
            ]),
            ...mapActions('objectModelClassify', [
                'searchClassificationsObjects',
                'createClassification',
                'updateClassification',
                'deleteClassification'
            ]),
            ...mapActions('objectModel', [
                'createObject'
            ]),
            isEditable (classification) {
                if (classification['classification_type'] === 'inner') {
                    return false
                }
                if (this.isAdminView) {
                    return true
                }
                return !!this.$tools.getMetadataBiz(classification)
            },
            isInner (model) {
                return !this.$tools.getMetadataBiz(model)
            },
            showGroupDialog (isEdit, group) {
                if (isEdit) {
                    if (!this.$isAuthorized(this.$OPERATION.U_MODEL_GROUP)) return
                    this.groupDialog.data.id = group.id
                    this.groupDialog.title = this.$t('ModelManagement["编辑分组"]')
                    this.groupDialog.data.classification_id = group['classification_id']
                    this.groupDialog.data.classification_name = group['classification_name']
                    this.groupDialog.data.id = group.id
                } else {
                    if (!this.$isAuthorized(this.$OPERATION.C_MODEL_GROUP)) return
                    this.groupDialog.title = this.$t('ModelManagement["新建分组"]')
                    this.groupDialog.data.classification_id = ''
                    this.groupDialog.data.classification_name = ''
                    this.groupDialog.data.id = ''
                }
                this.groupDialog.isEdit = isEdit
                this.groupDialog.isShow = true
            },
            hideGroupDialog () {
                this.groupDialog.isShow = false
                this.$validator.reset()
            },
            async saveGroup () {
                const res = await Promise.all([
                    this.$validator.validate('classifyId'),
                    this.$validator.validate('classifyName')
                ])
                if (res.includes(false)) {
                    return
                }
                const params = this.$injectMetadata({
                    org_id: this.supplierAccount,
                    classification_id: this.groupDialog.data['classification_id'],
                    classification_name: this.groupDialog.data['classification_name']
                })
                if (this.groupDialog.isEdit) {
                    // eslint-disable-next-line
                    const res = await this.updateClassification({
                        id: this.groupDialog.data.id,
                        params,
                        config: {
                            requestId: 'updateClassification'
                        }
                    })
                    this.updateClassify({ ...params, ...{ id: this.groupDialog.data.id } })
                } else {
                    const res = await this.createClassification({
                        params,
                        config: { requestId: 'createClassification' }
                    })
                    this.updateClassify({ ...params, ...{ id: res.id } })
                }
                this.hideGroupDialog()
            },
            deleteGroup (group) {
                if (!this.$isAuthorized(this.$OPERATION.D_MODEL_GROUP)) return
                this.$bkInfo({
                    title: this.$t('ModelManagement["确认要删除此分组"]'),
                    confirmFn: async () => {
                        await this.deleteClassification({
                            id: group.id,
                            config: {
                                data: this.$injectMetadata({}, {
                                    inject: !!this.$tools.getMetadataBiz(group)
                                })
                            }
                        })
                        this.$store.commit('objectModelClassify/deleteClassify', group['classification_id'])
                    }
                })
            },
            showModelDialog () {
                this.modelDialog.isShow = true
            },
            async saveModel (data) {
                const params = this.$injectMetadata({
                    org_id: this.supplierAccount,
                    obj_name: data['obj_name'],
                    obj_icon: data['obj_icon'],
                    classification_id: data['classification_id'],
                    obj_id: data['obj_id'],
                    userName: this.userName
                })
                await this.createObject({ params, config: { requestId: 'createModel' } })
                this.$http.cancel('post_searchClassificationsObjects')
                this.searchClassificationsObjects({
                    params: this.$injectMetadata()
                })
                this.modelDialog.isShow = false
            },
            modelClick (model) {
                this.$store.commit('objectModel/setActiveModel', model)
                this.$store.commit('setHeaderStatus', {
                    back: true
                })
                this.$router.push({
                    name: 'modelDetails',
                    params: {
                        modelId: model['obj_id']
                    }
                })
            }
        }
    }
</script>

<style lang="scss" scoped>
    .group-wrapper {
        padding: 130px 20px 20px 0;
    }
    .btn-group {
        position: absolute;
        top: 0;
        left: 0;
        width: calc(100% - 8px);
        padding: 20px;
        font-size: 0;
        background-color: #fff;
        z-index: 100;
        .bk-primary {
            margin-right: 10px;
        }
        &.sticky {
            box-shadow: 0 0 8px 1px rgba(0, 0, 0, 0.03);
        }
    }
    .model-type-options {
        margin: 6px 0;
        font-size: 0;
        text-align: right;
        position: relative;
        z-index: 1;
        .model-type-button {
            position: relative;
            margin: 0;
            font-size: 12px;
            &.enable {
                border-radius: 2px 0 0 2px;
                z-index: 2;
            }
            &.disabled {
                border-radius: 0 2px 2px 0;
                margin-left: -1px;
                z-index: 1;
            }
            &:hover {
                z-index: 2;
            }
        }
    }
    .group-list {
        padding: 0 20px 20px;
        .group-item {
            position: relative;
            padding: 10px 0 20px;
            >.icon-angle-double-down {
                position: absolute;
                left: 50%;
                bottom: -5px;
                margin-left: -5px;
                padding: 5px;
                font-size: 12px;
                cursor: pointer;
                transition: all .2s;
                &.rotate {
                    transform: rotate(180deg);
                }
            }
        }
        .group-title {
            display: inline-block;
            padding: 0 40px 0 0;
            line-height: 21px;
            color: #333948;
            &:before {
                content: "";
                display: inline-block;
                width:4px;
                height:14px;
                margin: 0 10px 0 0;
                vertical-align: middle;
                background: $cmdbBorderColor;
            }
            >span {
                display: inline-block;
                vertical-align: middle;
            }
            .number {
                color: $cmdbBorderColor;
            }
            >.text-primary {
                display: none;
                vertical-align: middle;
                cursor: pointer;
            }
            &:hover {
                >.text-primary {
                    display: inline-block;
                }
            }
        }
    }
    .model-list {
        padding-left: 12px;
        overflow: hidden;
        transition: height .2s;
        .model-item {
            position: relative;
            float: left;
            margin: 10px 10px 0 0;
            width: calc((100% - 10px * 4) / 5);
            height: 70px;
            border: 1px solid $cmdbTableBorderColor;
            border-radius: 4px;
            cursor: pointer;
            &:nth-child(5n) {
                margin-right: 0;
            }
            &.ispaused {
                background: #fcfdfe;
                border-color: #dde4eb;
                .icon-box {
                    color: #96c2f7;
                }
                .model-name {
                    color: #bfc7d2;
                }
            }
            &.ispre {
                .icon-box {
                    color: #798aad;
                }
            }
            &:hover {
                border-color: $cmdbBorderFocusColor;
                background: #ebf4ff;
            }
            .icon-box {
                float: left;
                width: 66px;
                text-align: center;
                font-size: 32px;
                color: $cmdbBorderFocusColor;
                .icon {
                    line-height: 68px;
                }
            }
            .model-details {
                padding: 0 10px 0 0;
                overflow: hidden;
            }
            .model-name {
                margin-top: 16px;
                line-height: 19px;
                font-size: 14px;
                @include ellipsis;
            }
            .model-id {
                line-height: 16px;
                font-size: 12px;
                color: #bfc7d2;
                @include ellipsis;
            }
        }
    }
    .dialog {
        .dialog-content {
            padding: 20px 15px 20px 28px;
        }
        .title {
            font-size: 20px;
            color: #333948;
            line-height: 1;
        }
        .label-item,
        label {
            display: block;
            margin-bottom: 10px;
            font-size: 0;
            &:last-child {
                margin: 0;
            }
            .color-danger {
                display: inline-block;
                font-size: 16px;
                width: 15px;
                text-align: center;
                vertical-align: middle;
            }
            .icon-info-circle {
                font-size: 18px;
                color: $cmdbBorderColor;
            }
            .label-title {
                font-size: 16px;
                line-height: 36px;
                vertical-align: middle;
                @include ellipsis;
            }
            .cmdb-form-item {
                display: inline-block;
                margin-right: 10px;
                width: 519px;
                vertical-align: middle;
            }
        }
        .footer {
            padding: 0 24px;
            font-size: 0;
            text-align: right;
            .bk-primary {
                margin-right: 10px;
            }
        }
    }
</style>
